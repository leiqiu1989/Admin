define("common/map",[],function(require,exports,module){"use strict";var map=function(){this._map=null,this.centerPoint=null,this.mouseMove_marker=null,this.mouseMoveClick_marker=null,this.points=[],this.stopPoints=[],this.runPoints=[],this.trackMarks=[],this.selectedMonitorCar=null};map.prototype={reset:function(){this._map=null,this.centerPoint=null,this.mouseMove_marker=null,this.mouseMoveClick_marker=null,this.stopPoints=[],this.runPoints=[],this.trackMarks=[],this.points=[],this.selectedMonitorCar=null},clearData:function(){this._map.clearOverlays(),this.mouseMove_marker=null,this.mouseMoveClick_marker=null,this.stopPoints=[],this.runPoints=[],this.trackMarks=[],this.points=[],this.selectedMonitorCar=null},init:function(e,i,t){var n=this;if(this.reset(),this._map=new BMap.Map(e),i)this.setCenterAndZoom([i]);else{var a=new BMap.LocalCity;a.get(function(e){var i=e.name;n.centerPoint=e.center,n._map.centerAndZoom(i)})}this._map.setMinZoom(6),this._map.setMaxZoom(18),this._map.enableScrollWheelZoom(),this._map.addControl(new BMap.NavigationControl),t&&t(this._map)},addDrawing:function(e){var i=this,t={strokeColor:"blue",fillColor:"",strokeWeight:3,strokeOpacity:.8,fillOpacity:.6,strokeStyle:"solid"},n=new BMapLib.DrawingManager(this._map,{isOpen:!1,enableDrawingTool:!0,drawingToolOptions:{anchor:BMAP_ANCHOR_TOP_LEFT,offset:new BMap.Size(120,22),drawingModes:[BMAP_DRAWING_RECTANGLE]},rectangleOptions:t});n.addEventListener("overlaycomplete",function(t){var a=0,o=0,r=0,s=0,l=t.overlay;i._map.removeOverlay(t.overlay),n.close();var p=l.getPath();if(p.length>0){var c=_.map(p,"lng"),d=_.map(p,"lat");a=_.max(c),o=_.max(d),r=_.min(c),s=_.min(d)}"function"==typeof e&&e({MinLng:r,MinLat:s,MaxLng:a,MaxLat:o})})},clearOverlays:function(){this._map.clearOverlays()},GetInfoWindow:function(e){var i="";return i=0===e.IsOnline?"离线":e.Status.indexOf("ACC开")>-1||1==e.IsOnline?"发动机开":e.Status.indexOf("ACC关")-1?"ACC关":"未知状态","<div class='point_info_title'><div class='point_title_left'>车牌号："+e.PlateNo+"</div><div style='display:inline-block'>"+e.GpsTime+"</div></div><div class='point_info_row'><div class='point_info_left'>车辆状态："+i+"</div><div class='point_info_right'>速度："+e.Speed+"公里/小时</div></div><div class='point_info_row'><div class='point_info_left'>停车时长：0</div><div class='point_info_right'>方向："+e.DirectionDesc+"</div></div>"+(e.AlarmInfo?"<div class='point_info_row'><div class='point_info_right'>车辆警情："+e.AlarmInfo+"</div></div>":"")+"</div><div class='point_info_addr ellipsis' title='"+e.Location+"'>位置："+e.Location+"</div><div class='point_btn'><div class='point_btn_info br' onclick='showVehicleInfo("+e.Vid+")'>车辆详细资料</div><div class='point_btn_info js-car-track' onclick=\"showVehicleTrack('"+e.Vid+"','"+e.PlateNo+"')\">轨迹回放</div></div>"},getMap:function(){return this._map},addTrackMark:function(e){var i=this,t=new BMap.Label("",{offset:new BMap.Size((-25),35)});t.setStyle({borderRadius:"3px",display:"inline-block",padding:"5px 10px",border:"0",color:"#1E2533",fontSize:"12px",lineHeight:"15px",fontFamily:"微软雅黑",boxShadow:"0 0 8px 0 #A1A7B3"}),t.setContent(e.PlateNo);var n=new BMap.Icon(window.DOMAIN+"/img/map/green1.png",new BMap.Size(30,30)),a=new BMap.Icon(window.DOMAIN+"/img/map/gray1.png",new BMap.Size(30,30)),o=new BMap.Marker(new BMap.Point(e.Lng,e.Lat),{icon:e.IsOnline?n:a});o.setLabel(t),o.setRotation(e.Degrees),this._map.addOverlay(o);var r={width:400,height:190,title:"",enableMessage:!0};e.AlarmInfo&&(r.height=220),BMapLib.EventWrapper.addDomListener(o,"click",function(t){i.selectedMonitorCar="tr_monitor_"+e.PlateNo;var n=$('tr[data-flag="'+i.selectedMonitorCar+'"]');$(n).data("vid");$("#carMonitorList tbody tr").removeClass("monitor-active"),n.hasClass("monitor-active")?o.closeInfoWindow():n.addClass("monitor-active"),$("#carMonitorList").scrollTop($(n).offset().top-$("#carMonitorList").offset().top+$("#carMonitorList").scrollTop());var a=new BMap.InfoWindow(i.GetInfoWindow(e),r);BMapLib.EventWrapper.addDomListener(a,"clickclose",function(e){i.selectedMonitorCar=null,$("#carMonitorList tbody tr").removeClass("monitor-active")}),o.openInfoWindow(a)}),this.trackMarks.push(o)},bindMonitorListEvent:function(){var e=this;$("#carMonitorList tbody tr").on("click",function(){var i=$(this).index(),t=$("#carMonitorList").scrollTop();e._map.setCenter(e.trackMarks[i].getPosition()),BMapLib.EventWrapper.trigger(e.trackMarks[i],"click"),t&&$("#carMonitorList").scrollTop(t)})},setCenterAndZoom:function(mapPoints){var view=this._map.getViewport(eval(mapPoints)),mapZoom=view.zoom,centerPoint=view.center;this._map.centerAndZoom(centerPoint,mapZoom)},summerPoint:function(e){var i=this;$.each(e,function(e,t){i.points.push(t)})},addAlarm:function(e){for(var i=0,t=e.length;i<t;i++){var n=e[i],a=new BMap.Marker(new BMap.Point(n.longitude,n.latitude),{icon:new BMap.Icon(window.DOMAIN+"/img/icon_stop.png",new BMap.Size(16,16))}),o={offset:new BMap.Size(12,(-30))},r=new BMap.Label("<div class='mapCarItem'>"+n.alarmTypeName+"&nbsp;&nbsp;"+n.speed+"Km/h</div><div class='mapCarItem'>"+n.beginTimeStr+"&nbsp;&nbsp;&nbsp;持续:"+n.keepTimeStr+"</div>",o);r.setStyle({color:"#333",fontSize:"12px",padding:"5px",fontFamily:"微软雅黑"}),this._map.addOverlay(a),a.setLabel(r)}},generateMapPoints:function(e){var i=[];return $.each(e,function(e,t){var n=new BMap.Point(t.Lng,t.Lat);i.push(n)}),i},driving:function(e,i){var t=this;$(".track-time").text(e[0].GpsTime);var n=new BMap.DrivingRoute(this._map);n.search(new BMap.Point(e[0].lng,e[0].lat),new BMap.Point(e[e.length-1].lng,e[e.length-1].lat)),n.setSearchCompleteCallback(function(){var n=t.generateMapPoints(e);t.summerPoint(e),t.addTrackLine(n),t.setCenterAndZoom(n),i&&i()})},addTrackLine:function(e){var i=this;this._map.clearOverlays();var t=new BMap.Polyline(e,{strokeColor:"blue",strokeWeight:4,strokeOpacity:.7});this._map.addOverlay(t);var n=new BMap.Marker(e[0],{icon:new BMap.Icon(window.DOMAIN+"/img/start.png",new BMap.Size(26,40),{imageOffset:new BMap.Size(0,0)})});this._map.addOverlay(n);var a=new BMap.Marker(e[e.length-1],{icon:new BMap.Icon(window.DOMAIN+"/img/end.png",new BMap.Size(26,40),{imageOffset:new BMap.Size(0,0)})});this._map.addOverlay(a),t.addEventListener("mousemove",function(e){var t=e.point.lng,n=(e.point.lat,_.map(i.points,function(e){return e.Lng})),a=[];n.map(function(e){a.push(Math.abs(e-t))});var o=a.indexOf(Math.min.apply(null,a));i.addMarker(i.points[o])}),t.addEventListener("mouseout",function(e){i._map.removeOverlay(i.mouseMove_marker)})},addMarker:function(e){var i=this;this.mouseMove_marker&&this._map.removeOverlay(this.mouseMove_marker);var t=new BMap.Marker(new BMap.Point(e.Lng,e.Lat),{icon:new BMap.Icon(window.DOMAIN+"/img/icon_pathway.png",new BMap.Size(16,16))}),n={position:new BMap.Point(e.Lng,e.Lat),offset:new BMap.Size(5,(-55))},a=new BMap.Label("时间："+e.GpsTime+"<br/>速度："+e.Speed+"km/h",n);a.setStyle({color:"#333",fontSize:"12px",padding:"5px 10px",lineHeight:"20px",fontFamily:"微软雅黑",border:"1px solid #ccc"}),t.setLabel(a),this.mouseMove_marker=t,t.addEventListener("click",function(){i.clickMarker(e)}),this._map.addOverlay(t)},clickMarker:function(e){var i=this;i.mouseMoveClick_marker&&this._map.removeOverlay(i.mouseMoveClick_marker),this._map.removeOverlay(this.mouseMove_marker);var t=new BMap.Marker(new BMap.Point(e.Lng,e.Lat),{icon:new BMap.Icon(window.DOMAIN+"/img/icon_pathway.png",new BMap.Size(16,16))}),n="<div class='mapCarItem'>车牌："+e.PlateNo+"</div><div class='mapCarItem'>时间："+e.GpsTime+"</div><div class='mapCarItem'>速度："+e.Speed+"km/h</div><div class='mapCarItem'><div class='pull-left'>位置：</div><div style='margin-left:36px;max-height: 37px;overflow: hidden;' title='"+e.Location+"'>"+e.Location+"</div></div>",a={width:300,height:100,title:"",enableMessage:!1},o=new BMap.InfoWindow(n,a);o.addEventListener("close",function(){i._map.removeOverlay(t)}),this._map.addOverlay(t),t.openInfoWindow(o)},markStopPoint:function(e){var i=this,t=new BMap.Marker(new BMap.Point(e.Lng,e.Lat),{icon:new BMap.Icon(window.DOMAIN+"/img/icon_stop.png",new BMap.Size(16,16),{imageOffset:new BMap.Size(0,0)})}),n=new BMap.Point(e.Lng,e.Lat),a="";a="<div class='mapCarItem'>车牌号码："+plateNumber+"</div><div class='mapCarItem'>开始时间："+e.GpsTime+"</div><div class='mapCarItem'>结束时间："+e.endGpsTime+"</div><div class='mapCarItem'>停留时长："+e.duration+"</div><div class='mapCarItem'><div class='pull-left'>停留位置：</div><div style='margin-left:60px;' title='"+e.location+"'>"+e.location+"</div></div>";var o={width:300,height:120,title:"",enableMessage:!1},r=new BMap.InfoWindow(a,o);this._map.addOverlay(t),t.addEventListener("click",function(){this.openInfoWindow(r),i._map.panTo(n)})}};var _map=new map;module.exports=_map});