define("common/common",["api","map","underscore","../../tpl/common/areaIndex"],function(e,t,a){"use strict";var n=e("api"),i=e("map");e("underscore"),Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var a in t)new RegExp("("+a+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[a]:("00"+t[a]).substr((""+t[a]).length)));return e},template.helper("formateDate",function(e,t){return t=t||"yyyy/MM/dd",e?new Date(e).format(t):""});var o={layUIDialog:function(e){layui.use("layer",function(){var t=layui.layer;t.open($.extend(e,{offset:"60px"}))})},layMsg:function(e){layui.use("layer",function(){var t=layui.layer;t.msg(e,{offset:"t"})})},layAlert:function(e,t){t=t||{};var a=$.extend({icon:2},t);return layer.alert(e,a),!1},layConfirm:function(e,t){layer.confirm(e,{btn:["确定","取消"]},function(){t&&t(),layer.closeAll()},function(){layer.closeAll()})},renderForm:function(e){layui.use("form",function(){var t=layui.form;t.verify({"int":[/^\+?[1-9][0-9]*$/,"只能输入大于0的正整数"]}),t.render(),e&&e(t)})},getSelectedRow:function(e,t){var a=e.checkStatus(t),n=a.data.length;if(1!==n)return this.layAlert("请选择一条数据进行操作!"),{success:!1};var i=a.data[0];return{success:!0,data:i}},transLngLat:function(e){if(e){var t=e.split(",");return{Lng:parseFloat(t[0]),Lat:parseFloat(t[1])}}return{}},setRadioCheckValue:function(e,t){t=t||[],_.each(t,function(a,n){$(e).find(t[n]).attr("checked",!0)})},initSelect:function(e){e=e||{el:"",data:[],textField:e.textField||"name",valueField:e.valueField||"value",selectValue:""};var t="";$.each(e.data,function(a,n){var i=n[e.valueField];t+=e.selectValue&&e.selectValue==i?'<option value="'+n[e.valueField]+'" selected>'+n[e.textField]+"</option>":'<option value="'+n[e.valueField]+'">'+n[e.textField]+"</option>"}),$(e.el).empty().html(t)},initDateTime:function(e){layui.use("laydate",function(){var t=layui.laydate;t.render(e)})},renderContent:function(e,t){t=t||{},$("#content").removeAttr("style").empty().html(template.compile(e)(t))},searchTree:function(e,t){function a(e,t){var n=t.getParentNode();n&&(i.push(n),a(e,n))}function n(e,t){var a=t.children;if(a)for(var o=0;o<a.length;o++)i.push(a[o]),n(e,a[o])}var i=null,o=null,r=$.fn.zTree.getZTreeObj(e);if(t){o=r.getNodes(),o=r.transformToArray(o),r.hideNodes(o),o=r.getNodesByParamFuzzy("ADNM",t),i=r.getNodesByParamFuzzy("ADNM",t);for(var l=0;l<o.length;l++)a(r,o[l]),n(r,o[l])}else i=r.transformToArray(r.getNodes());r.showNodes(i)},initTree:function(e){var t=this;e=e||{url:null,param:{},treeId:null,idKey:null,pIdKey:null,dataFilter:$.noop,callback:$.noop,hasSearchClick:!1,expandFlag:!1,checkEnable:!1};var a={view:{selectedMulti:!1},check:{enable:e.checkEnable},data:{simpleData:{enable:!0,idKey:e.idKey,pIdKey:e.pIdKey,rootPId:null},key:{name:e.name}},callback:{onClick:e.callback}};t.ajax(e.url,e.param,function(n){if(n.IsSuccess){var i=n.Data||[];e.dataFilter&&(i=e.dataFilter(i)),$.fn.zTree.init($("#"+e.treeId),a,i);var o=$.fn.zTree.getZTreeObj(e.treeId);o.expandAll(e.expandFlag),e.hasSearchClick&&$("#btnSearchTree").on("click",function(){var a=$.trim($(':text[name="treeText"]').val());t.searchTree(e.treeId,a)})}})},areaMapDialog:function(t,a,o){var r=this;$(t).off().on("click","#choseArea",function(){var t=null,a=null,i=e("../../tpl/common/areaIndex");return r.layUIDialog({title:"区域选择",type:1,content:i,area:["300px","500px"],success:function(e){r.initTree({url:n.getAreaList,param:{},treeId:"commonTree",idKey:"ADCD",pIdKey:"ParentCode",name:"ADNM",hasSearchClick:!0,callback:function(e,n,i){t=i.ADCD,a=i.ADNM}})},btnAlign:"r",btn:["确 定","关 闭"],yes:function(e){o&&o(t,a),layer.close(e)},btn2:function(e){layer.close(e)}}),!1}).on("click","#choseLngLat",function(){function e(e){e.addEventListener("dragend",function(e){t=e.point})}var t=null,n=$(this).prev(':text[name="lnglat"]').data("lnglat"),o=n?n.lng:null,l=n?n.lat:null;return r.layUIDialog({title:"添加标注点",type:1,content:'<div id="dialogMap" class="full"></div>',area:["500px","450px"],success:function(){i.init("dialogMap",null,function(){if(o&&l){var a=new BMap.Point(o,l),n=new BMap.Marker(a);n.enableDragging(),i.getMap().addOverlay(n),t=a,e(n)}})},btnAlign:"r",btn:["添加标注点","关 闭"],yes:function(){var a=i.getMap();i.clearOverlays();var n=new BMapLib.MarkerTool(a,{autoClose:!0,followText:"添加标注点"});n.open(),n.addEventListener("markend",function(a){t=a.marker.point,a.marker.enableDragging(),e(a.marker),n.close()})},btn2:function(e){t&&a&&a(t),layer.close(e)}}),!1})},transferDateTime:function(e){var t=e;if(_.isString(e)){var a=Date.parse(e);isNaN(a)||(t=new Date(a))}return _.isNumber(e)&&(t=new Date(e)),_.isDate(t)?t.format("yyyy-MM-dd hh:mm:ss"):t},checkMayBeEmptyTime:function(e,t){if(e||t){if(e&&t){var a=this.equalsTime(e,t);return a.result||this.toast("开始日期不能大于结束日期!"),a.result}return this.toast("日期不能为空!"),!1}return!0},equalsTime:function(e,t){e=_.isString(e)?Date.parse(e.replace(/-/g,"/")):Date.parse(e),t=_.isString(t)?Date.parse(t.replace(/-/g,"/")):Date.parse(t);var a=t-e;return{result:a>0,diffTimes:a}},checkTime:function(e,t,a){if(!e||!t)return o.toast("日期不能为空！"),!1;var n=this.equalsTime(t,e);if(a){var i=24*a*60*60*1e3;if(!n.result||n.diffTimes>i)return o.toast("时间周期必须小于或等于"+a+"天!"),!1}return!!n.result||(o.toast("结束日期必须大于或者开始日期!"),!1)},initBetweenDateTime:function(e,t,a){var n=(new Date).format("yyyy/MM/dd H:m"),i={lang:"ch",timepicker:!0,format:"Y/m/d H:i"},o=$.extend({},i,{maxDate:n}),r=$.extend({},i,{maxDate:n});$(e).datetimepicker(o),$(t).datetimepicker(r)},serialParam:function(e){var t="";return e&&_.isObject(e)&&$.each(e,function(e,a){t+=e+"="+a+"&"}),t.substring(0,t.length-1)},changeHash:function(e,t){var a=t?"&":"/";window.location.hash=e+this.serialParam(t)+a+"time="+(new Date).valueOf()},clearData:function(){this.setCookie("abc-sid",null,-1)},loading:function(e,t){t=t||"加载中...",e=e||"show",$("#glb_loading").size()<1&&$("#glb_loading_msg").size()<1&&($('<div id="glb_loading"></div>').appendTo("body"),$('<div id="glb_loading_msg">'+t+"</div>").appendTo("body")),"show"===e?$("#glb_loading,#glb_loading_msg").show():$("#glb_loading,#glb_loading_msg").hide()},setCookie:function(e,t,a){a=a||7,$.cookie(e,t,{expires:a})},getCookie:function(e){return $.cookie(e)},setlocationStorage:function(e,t){window.localStorage.setItem(e,t)},getlocationStorage:function(e){return window.localStorage.getItem(e)},removeLocationStorage:function(e){window.localStorage.removeItem(e)},getElValue:function(e,t){return t=t||"value","value"===t?$.trim($(e).val()):$.trim($(e).text())},setElValue:function(e,t){$(e).val(t)},getFormData:function(e){var t=$(e).find(":input").not('[data-nosubmit="true"]'),a={};return $(t).each(function(e,t){var n=null,i=null;if(n=$(t).attr("name")){if($(t).is(":checkbox")){var o=$(t).is(":checked");i=o?$(t).data("chkvalue"):$(t).data("unchkvalue")}else i="SELECT"===$(t)[0].tagName?$(t).children("option:selected").val():$(t).val();a[n]=i}}),a},setFormData:function(e,t){if(t&&!$.isEmptyObject(t)){var a=$(e).find(":input"),n=null;$(a).each(function(e,a){n=$(a).attr("name"),n&&("SELECT"===$(a)[0].tagName?$(a).val(t[n]):$(a).val(t[n]))})}},getQueryString:function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),a=window.location.search.substr(1).match(t);return null!=a?unescape(a[2]):null},getBundle:function(){var e=Array.prototype.slice.call(arguments),t=$.map(e,function(e){return _.isString(e)?$.get(e):e.done?e:$.get(e.url,e.data)}),a=$.Deferred();return $.when.apply($,t).done(function(){var e=_.toArray(arguments),t=_.map(e,function(e){return _.isArray(e)&&"success"===e[1]?e[0]:e});a.resolve.apply(a,t)}).fail(function(){a.reject(arguments)}),a.promise()},ajax:function(e,t,a,n){var i=this;return t=t||{},n=n||{},this.loading(),$.ajax($.extend({type:n.type||"GET",url:e,data:t,dataType:"json",cache:!1,success:function(e){if(e&&e.ErrorCode){var t=e.Message||"系统错误,请联系管理员";i.layAlert(t,{yes:function(e){layer.close(e),i.changeHash("#login/index")}})}a&&"function"==typeof a&&a.call(this,e)},error:function(e,t,a){}},n)).always(function(){i.loading("hide")})},$:function(e,t){return t=t||"#content",$(t).find(e)}};return o}),define("common/api",[],function(e,t,a){"use strict";var n="//192.168.0.200:88/apiserver",i={login:n+"/api/Account/Login",getPlaySource:n+"/api/Common/getPlaySourceType",getAreaList:n+"/api/Common/getAreaTree",getDepartMent:n+"/api/Department/getDeptTree",getModemType:n+"/api/Common/getModeTypeList",getModemList:n+"/api/Modem/getModemListByAreaCode",addModem:n+"/api/Modem/AddModem",detailModem:n+"/api/Modem/GetDetailById",updateModem:n+"/api/Modem/UpdateModem",deleteModem:n+"/api/Modem/DeleteModem",addDepartment:n+"/api/Department/AddDepartMent",updateDepartment:n+"/api/Department/EditDepartment",detailDepartment:n+"/api/Department/GetDepartmentByUserId",deleteDepartment:n+"/api/Department/DeleteDepartment",getUserList:n+"/api/Department/getUserList",getUserListByDeptId:n+"/api/Department/getUserListByDeptId",getUserList:n+"/api/User/getUserList",getUserByUserId:n+"/api/User/GetUserByUserId",addUser:n+"/api/User/AddUser",editUser:n+"/api/User/EditUser",deleteUser:n+"/api/User/DeleteUser"};return i}),define("common/map",[],function(require,exports,module){"use strict";var map=function(){this._map=null,this.centerPoint=null,this.mouseMove_marker=null,this.mouseMoveClick_marker=null,this.points=[],this.stopPoints=[],this.runPoints=[],this.trackMarks=[],this.selectedMonitorCar=null};map.prototype={reset:function(){this._map=null,this.centerPoint=null,this.mouseMove_marker=null,this.mouseMoveClick_marker=null,this.stopPoints=[],this.runPoints=[],this.trackMarks=[],this.points=[],this.selectedMonitorCar=null},clearData:function(){this._map.clearOverlays(),this.mouseMove_marker=null,this.mouseMoveClick_marker=null,this.stopPoints=[],this.runPoints=[],this.trackMarks=[],this.points=[],this.selectedMonitorCar=null},init:function(e,t,a){var n=this;if(t=t||{addNavigation:!0},this.reset(),this._map=new BMap.Map(e),t.defaultPoint)this.setCenterAndZoom([t.defaultPoint]);else{var i=new BMap.LocalCity;i.get(function(e){var t=e.name;n.centerPoint=e.center,n._map.centerAndZoom(t)})}this._map.setMinZoom(6),this._map.setMaxZoom(18),this._map.enableScrollWheelZoom(),t.addNavigation&&this._map.addControl(new BMap.NavigationControl),a&&a(this._map)},addDrawing:function(e){var t=this,a={strokeColor:"blue",fillColor:"",strokeWeight:3,strokeOpacity:.8,fillOpacity:.6,strokeStyle:"solid"},n=new BMapLib.DrawingManager(this._map,{isOpen:!1,enableDrawingTool:!0,drawingToolOptions:{anchor:BMAP_ANCHOR_TOP_LEFT,offset:new BMap.Size(120,22),drawingModes:[BMAP_DRAWING_RECTANGLE]},rectangleOptions:a});n.addEventListener("overlaycomplete",function(a){var i=0,o=0,r=0,l=0,s=a.overlay;t._map.removeOverlay(a.overlay),n.close();var c=s.getPath();if(c.length>0){var d=_.map(c,"lng"),p=_.map(c,"lat");i=_.max(d),o=_.max(p),r=_.min(d),l=_.min(p)}"function"==typeof e&&e({MinLng:r,MinLat:l,MaxLng:i,MaxLat:o})})},clearOverlays:function(){this._map.clearOverlays()},GetInfoWindow:function(e){var t="";return t=0===e.IsOnline?"离线":e.Status.indexOf("ACC开")>-1||1==e.IsOnline?"发动机开":e.Status.indexOf("ACC关")-1?"ACC关":"未知状态","<div class='point_info_title'><div class='point_title_left'>车牌号："+e.PlateNo+"</div><div style='display:inline-block'>"+e.GpsTime+"</div></div><div class='point_info_row'><div class='point_info_left'>车辆状态："+t+"</div><div class='point_info_right'>速度："+e.Speed+"公里/小时</div></div><div class='point_info_row'><div class='point_info_left'>停车时长：0</div><div class='point_info_right'>方向："+e.DirectionDesc+"</div></div>"+(e.AlarmInfo?"<div class='point_info_row'><div class='point_info_right'>车辆警情："+e.AlarmInfo+"</div></div>":"")+"</div><div class='point_info_addr ellipsis' title='"+e.Location+"'>位置："+e.Location+"</div><div class='point_btn'><div class='point_btn_info br' onclick='showVehicleInfo("+e.Vid+")'>车辆详细资料</div><div class='point_btn_info js-car-track' onclick=\"showVehicleTrack('"+e.Vid+"','"+e.PlateNo+"')\">轨迹回放</div></div>"},getMap:function(){return this._map},addTrackMark:function(e){var t=this,a=new BMap.Label("",{offset:new BMap.Size((-25),35)});a.setStyle({borderRadius:"3px",display:"inline-block",padding:"5px 10px",border:"0",color:"#1E2533",fontSize:"12px",lineHeight:"15px",fontFamily:"微软雅黑",boxShadow:"0 0 8px 0 #A1A7B3"}),a.setContent(e.PlateNo);var n=new BMap.Icon(window.DOMAIN+"/img/map/green1.png",new BMap.Size(30,30)),i=new BMap.Icon(window.DOMAIN+"/img/map/gray1.png",new BMap.Size(30,30)),o=new BMap.Marker(new BMap.Point(e.Lng,e.Lat),{icon:e.IsOnline?n:i});o.setLabel(a),o.setRotation(e.Degrees),this._map.addOverlay(o);var r={width:400,height:190,title:"",enableMessage:!0};e.AlarmInfo&&(r.height=220),BMapLib.EventWrapper.addDomListener(o,"click",function(a){t.selectedMonitorCar="tr_monitor_"+e.PlateNo;var n=$('tr[data-flag="'+t.selectedMonitorCar+'"]');$(n).data("vid");$("#carMonitorList tbody tr").removeClass("monitor-active"),n.hasClass("monitor-active")?o.closeInfoWindow():n.addClass("monitor-active"),$("#carMonitorList").scrollTop($(n).offset().top-$("#carMonitorList").offset().top+$("#carMonitorList").scrollTop());var i=new BMap.InfoWindow(t.GetInfoWindow(e),r);BMapLib.EventWrapper.addDomListener(i,"clickclose",function(e){t.selectedMonitorCar=null,$("#carMonitorList tbody tr").removeClass("monitor-active")}),o.openInfoWindow(i)}),this.trackMarks.push(o)},bindMonitorListEvent:function(){var e=this;$("#carMonitorList tbody tr").on("click",function(){var t=$(this).index(),a=$("#carMonitorList").scrollTop();e._map.setCenter(e.trackMarks[t].getPosition()),BMapLib.EventWrapper.trigger(e.trackMarks[t],"click"),a&&$("#carMonitorList").scrollTop(a)})},setCenterAndZoom:function(mapPoints){var view=this._map.getViewport(eval(mapPoints)),mapZoom=view.zoom,centerPoint=view.center;this._map.centerAndZoom(centerPoint,mapZoom)},summerPoint:function(e){var t=this;$.each(e,function(e,a){t.points.push(a)})},addAlarm:function(e){for(var t=0,a=e.length;t<a;t++){var n=e[t],i=new BMap.Marker(new BMap.Point(n.longitude,n.latitude),{icon:new BMap.Icon(window.DOMAIN+"/img/icon_stop.png",new BMap.Size(16,16))}),o={offset:new BMap.Size(12,(-30))},r=new BMap.Label("<div class='mapCarItem'>"+n.alarmTypeName+"&nbsp;&nbsp;"+n.speed+"Km/h</div><div class='mapCarItem'>"+n.beginTimeStr+"&nbsp;&nbsp;&nbsp;持续:"+n.keepTimeStr+"</div>",o);r.setStyle({color:"#333",fontSize:"12px",padding:"5px",fontFamily:"微软雅黑"}),this._map.addOverlay(i),i.setLabel(r)}},generateMapPoints:function(e){var t=[];return $.each(e,function(e,a){var n=new BMap.Point(a.Lng,a.Lat);t.push(n)}),t},driving:function(e,t){var a=this;$(".track-time").text(e[0].GpsTime);var n=new BMap.DrivingRoute(this._map);n.search(new BMap.Point(e[0].lng,e[0].lat),new BMap.Point(e[e.length-1].lng,e[e.length-1].lat)),n.setSearchCompleteCallback(function(){var n=a.generateMapPoints(e);a.summerPoint(e),a.addTrackLine(n),a.setCenterAndZoom(n),t&&t()})},addTrackLine:function(e){var t=this;this._map.clearOverlays();var a=new BMap.Polyline(e,{strokeColor:"blue",strokeWeight:4,strokeOpacity:.7});this._map.addOverlay(a);var n=new BMap.Marker(e[0],{icon:new BMap.Icon(window.DOMAIN+"/img/start.png",new BMap.Size(26,40),{imageOffset:new BMap.Size(0,0)})});this._map.addOverlay(n);var i=new BMap.Marker(e[e.length-1],{icon:new BMap.Icon(window.DOMAIN+"/img/end.png",new BMap.Size(26,40),{imageOffset:new BMap.Size(0,0)})});this._map.addOverlay(i),a.addEventListener("mousemove",function(e){var a=e.point.lng,n=(e.point.lat,_.map(t.points,function(e){return e.Lng})),i=[];n.map(function(e){i.push(Math.abs(e-a))});var o=i.indexOf(Math.min.apply(null,i));t.addMarker(t.points[o])}),a.addEventListener("mouseout",function(e){t._map.removeOverlay(t.mouseMove_marker)})},addMarker:function(e){var t=this;this.mouseMove_marker&&this._map.removeOverlay(this.mouseMove_marker);var a=new BMap.Marker(new BMap.Point(e.Lng,e.Lat),{icon:new BMap.Icon(window.DOMAIN+"/img/icon_pathway.png",new BMap.Size(16,16))}),n={position:new BMap.Point(e.Lng,e.Lat),offset:new BMap.Size(5,(-55))},i=new BMap.Label("时间："+e.GpsTime+"<br/>速度："+e.Speed+"km/h",n);i.setStyle({color:"#333",fontSize:"12px",padding:"5px 10px",lineHeight:"20px",fontFamily:"微软雅黑",border:"1px solid #ccc"}),a.setLabel(i),this.mouseMove_marker=a,a.addEventListener("click",function(){t.clickMarker(e)}),this._map.addOverlay(a)},clickMarker:function(e){var t=this;t.mouseMoveClick_marker&&this._map.removeOverlay(t.mouseMoveClick_marker),this._map.removeOverlay(this.mouseMove_marker);var a=new BMap.Marker(new BMap.Point(e.Lng,e.Lat),{icon:new BMap.Icon(window.DOMAIN+"/img/icon_pathway.png",new BMap.Size(16,16))}),n="<div class='mapCarItem'>车牌："+e.PlateNo+"</div><div class='mapCarItem'>时间："+e.GpsTime+"</div><div class='mapCarItem'>速度："+e.Speed+"km/h</div><div class='mapCarItem'><div class='pull-left'>位置：</div><div style='margin-left:36px;max-height: 37px;overflow: hidden;' title='"+e.Location+"'>"+e.Location+"</div></div>",i={width:300,height:100,title:"",enableMessage:!1},o=new BMap.InfoWindow(n,i);o.addEventListener("close",function(){t._map.removeOverlay(a)}),this._map.addOverlay(a),a.openInfoWindow(o)},markStopPoint:function(e){var t=this,a=new BMap.Marker(new BMap.Point(e.Lng,e.Lat),{icon:new BMap.Icon(window.DOMAIN+"/img/icon_stop.png",new BMap.Size(16,16),{imageOffset:new BMap.Size(0,0)})}),n=new BMap.Point(e.Lng,e.Lat),i="";i="<div class='mapCarItem'>车牌号码："+plateNumber+"</div><div class='mapCarItem'>开始时间："+e.GpsTime+"</div><div class='mapCarItem'>结束时间："+e.endGpsTime+"</div><div class='mapCarItem'>停留时长："+e.duration+"</div><div class='mapCarItem'><div class='pull-left'>停留位置：</div><div style='margin-left:60px;' title='"+e.location+"'>"+e.location+"</div></div>";var o={width:300,height:120,title:"",enableMessage:!1},r=new BMap.InfoWindow(i,o);this._map.addOverlay(a),a.addEventListener("click",function(){this.openInfoWindow(r),t._map.panTo(n)})}};var _map=new map;module.exports=_map});